# whmcs-bb-pix

## Requirements and Support
- PHP: 8.1. Ext: GD, mbstring
- WHMCS: 8.6+

## Installation Mode
1. Download the module .zip file.
2. It is recommended to delete the previous version of the module from your WHMCS.
3. Unzip and upload the extracted content to the WHMCS installation root.

## Configuration
For the minimum operation of the module, the following configurations must be filled:
- developer_application_key
- client_id
- client_secret
- Basic Authorization
- Receiver key
- Trade name/legal name of the billing issuer
- City of the billing issuer
- Environment

This information is obtained from the [BB Developers Portal](https://app.developers.bb.com.br/core/gcs/statics/login/login.novo.bb?tipo=st_cpf&urlRetorno=https%3A%2F%2Fapp.developers.bb.com.br%2F%23%2Flogin#/st-cpf).

Pay attention to filling in the credentials according to your environment: whether testing or production.

Other configurations are optional and allow the gateway to function with its default values:
- Pix Description
- Pix Expiration
- Custom field ID for CNPJ
- Custom field ID for CPF
- Insert the client's name and CPF/CNPJ in the Pix

## Usage Mode
- Access an invoice and select "Pix - Banco do Brasil".
- The Pix QR Code will be immediately generated.
- Make the payment within 1 minute, and the page will automatically update upon detecting the payment. If not, manually refresh the page with F5.

## Features
- Manual refund
- Automatic payment confirmation
- Manual payment confirmation
- Pix code sharing
- Discount definition by product
- Discount definition for Pix payment
- Rules for applying discounts

## Developer Notes

### Discount Calculation

https://whmcs.community/topic/294264-api-get-the-product-id-from-getorders-call/

The product discount applies to the total product value, which is product value + its fees = total value.

### Logic of API txid and WHMCS transid
The BB API requests the sending of a txid to identify the Pix.
Thus, the txid is sent in this format: `0000xa09ad1679ebbaf88a92cd98fd4`.

Note that the `0000` before the `x` represents the ID of an invoice in WHMCS.
The characters after the `x` are randomly generated to reach the minimum size of 26 characters for the `txid`.

This logic is handled by the `PixTxId` class.

### Documentation

#### API V1
- Pix Documentation: https://apoio.developers.bb.com.br/referency/post/648382d5d7ffe20012f2c287
- Pix API Endpoints: https://apoio.developers.bb.com.br/referency/post/6483836ddcefbe00128886ce
- Postman Collection and testing Pix keys: https://apoio.developers.bb.com.br/referency/post/5ff4946ce2a4400012dad1d9
- API Testing Instructions: https://apoio.developers.bb.com.br/referency/post/5ff4946ce2a4400012dad1d9

In the testing environment, you can use one of the keys below:
- testqrcode01@bb.com.br
- 28779295827
- 7f6844d0-de89-47e5-9ef7-e0a35a681615
- 3d94a38b-f344-460e-b6c9-489469b2fb03
- d14d32de-b3b9-4c31-9f89-8df2cec92c50
- Pix payment simulation in testing: https://apoio.developers.bb.com.br/referency/post/61bcdd19b6164800123d7654

#### API V2
- API Testing Instructions: https://apoio.developers.bb.com.br/referency/post/5ff4946ce2a4400012dad1d9

- Webhook https://apoio.developers.bb.com.br/referency/post/64f878e5a7287f001313fc6e

#### Questions regarding API rules

Consult the [BB forum for developers](https://forum.developers.bb.com.br/)

- Special characters in the "solicitacaoPagador" field: [BB Forum](https://forum.developers.bb.com.br/t/caracteres-suportados-para-o-campo-solicitacaopagador-na-criacao-do-pix/10182/6)

- QR Code images generated by BB's testing API cannot be tested by apps like Nubank and others. [See more on the BB Developers Forum](https://forum.developers.bb.com.br/t/como-ler-qr-codes-gerados-com-a-api-de-homologacao/5688).